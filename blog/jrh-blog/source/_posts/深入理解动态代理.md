---
title: æ·±å…¥ç†è§£åŠ¨æ€ä»£ç†
date: 2019-09-25 20:50:20
categories:
- [java]
- [android]
tags:
- java
- android
---

## 

# æ·±å…¥ç†è§£åŠ¨æ€ä»£ç†

[æ¥æº](https://juejin.im/post/5c70094051882562a12aec51)



# ä¸€ã€æ¦‚è¿°

æœ€è¿‘åœ¨é˜…è¯»retrofitæºç æ—¶,æœ‰ä¸ªå…³é”®çš„æ‰€åœ¨å°±æ˜¯åŠ¨æ€ä»£ç†ï¼Œç»†ç»†å›æƒ³äº†ä¸€ä¸‹åŠ¨æ€ä»£ç†,å‘ç°ä¹‹å‰æœ‰äº›ç»†èŠ‚è¿˜æ²¡æœ‰ç†è§£åˆ°ä½ï¼Œæœ¬ç¯‡åšæ–‡å°†é‡æ–°æ·±å…¥ç†è§£ä¸€ä¸‹åŠ¨æ€ä»£ç†ã€‚

<!--more-->

# äºŒã€å…³äºä»£ç†

ä¸­ååæ—æ˜¯ä¸€ä¸ªå«è“„çš„åæ—ï¼Œè®²ç©¶å¾®å¦™å’Œé—´æ¥çš„äº¤æµæ–¹å¼ã€‚å¯¹è±¡ä¹‹é—´çš„é—´æ¥é€šä¿¡ä¹Ÿæ˜¯åŒæ ·æ˜¯é¢å‘å¯¹è±¡è®¾è®¡ä¸­ä¸€æ¡é‡è¦çš„å®¡ç¾è§‚ï¼Œè¿ªç±³ç‰¹æ³•åˆ™ä¹ŸæŒ‡å‡ºâ€œä¸€ä¸ªå¯¹è±¡åº”è¯¥å¯¹å…¶ä»–å¯¹è±¡ä¿æŒæœ€å°‘çš„äº†è§£â€,é—´æ¥é—´é€šä¿¡å¯ä»¥è¾¾åˆ°â€œé«˜å†…èšï¼Œä½è€¦åˆâ€çš„æ•ˆæœã€‚
ä»£ç†æ˜¯ä¸€ç§é‡è¦çš„æ‰‹æ®µä¹‹ä¸€ï¼Œæ¯”å¦‚ç”Ÿæ´»ä¸­çš„å¾®å•†ä»£ç†ï¼Œå‚å®¶å§”æ‰˜å…¶ä»£ç†é”€å”®å•†å“ï¼Œæˆ‘ä»¬åªè·Ÿå¾®å•†æ‰“äº¤é“ï¼Œä¸çŸ¥é“èƒŒåçš„â€œå‚å®¶æ˜¯è°â€ï¼Œå¾®å•†å’Œå‚å®¶å°±å¯ä»¥æŠ½è±¡ä¸º â€œä»£ç†ç±»â€å’Œâ€œå§”æ‰˜ç±»â€ï¼Œè¿™æ ·å°±å¯ä»¥ï¼Œéšè—å§”æ‰˜ç±»çš„å®ç°ã€å®ç°å®¢æˆ·ä¸å§”æ‰˜ç±»ä¹‹é—´çš„è§£è€¦ï¼Œå¯ä»¥ä¸ç”¨ä¿®æ”¹å§”æ‰˜ç±»çš„æƒ…å†µä¸‹åšä¸€äº›é¢å¤–çš„å¤„ç†

## 2.1ã€ä»£ç†æ¨¡å¼ç®€ä»‹

åœ¨ã€ŠJavaä¸æ¨¡å¼ã€‹ä¸€ä¹¦ä¸­æŒ‡å‡º"ä»£ç†æ¨¡å¼ç»™æŸä¸€ä¸ªå¯¹è±¡æä¾›ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œå¹¶ç”±ä»£ç†å¯¹è±¡æ§åˆ¶å¯¹åŸå¯¹è±¡çš„è®¿é—®"ï¼Œç±»å›¾å¦‚ä¸‹

![image.png](https://user-gold-cdn.xitu.io/2019/2/22/16915a41d98d4237?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)


é€šè¿‡ç±»å›¾å¯ä»¥å‘ç°ï¼Œä»£ç†æ¨¡å¼çš„ä»£ç†å¯¹è±¡`Proxy`å’Œç›®æ ‡å¯¹è±¡`Subject`å®ç°åŒä¸€ä¸ªæ¥å£ï¼Œå®¢æˆ·è°ƒç”¨çš„æ˜¯`Proxy`å¯¹è±¡ï¼Œ`Proxy`å¯ä»¥æ§åˆ¶`Subject`çš„è®¿é—®ï¼ŒçœŸæ­£çš„åŠŸèƒ½å®ç°æ˜¯åœ¨`Subject`å®Œæˆçš„ã€‚



é€‚ç”¨åœºæ™¯:

- ä¸å¸Œæœ›æŸäº›ç±»è¢«ç›´æ¥è®¿é—®ã€‚
- è®¿é—®ä¹‹å‰å¸Œæœ›å…ˆè¿›è¡Œä¸€äº›é¢„å¤„ç†ã€‚
- å¸Œæœ›å¯¹è¢«è®¿é—®çš„å¯¹è±¡è¿›è¡Œå†…å­˜ã€æƒé™ç­‰æ–¹é¢çš„æ§åˆ¶ã€‚

ä¼˜ç‚¹å¦‚ä¸‹

- ä»£ç†æ¨¡å¼æ˜¯é€šè¿‡ä½¿ç”¨å¼•ç”¨ä»£ç†å¯¹è±¡æ¥è®¿é—®çœŸå®å¯¹è±¡ï¼Œåœ¨è¿™é‡Œä»£ç†å¯¹è±¡å……å½“ç”¨äºè¿æ¥å®¢æˆ·ç«¯å’ŒçœŸå®å¯¹è±¡çš„ä¸­ä»‹è€…ã€‚
- ä»£ç†æ¨¡å¼ä¸»è¦ç”¨äºè¿œç¨‹ä»£ç†ã€è™šæ‹Ÿä»£ç†å’Œä¿æŠ¤ä»£ç†ã€‚å…¶ä¸­ä¿æŠ¤ä»£ç†å¯ä»¥è¿›è¡Œè®¿é—®æƒé™æ§åˆ¶ã€‚

## 2.2ã€é™æ€ä»£ç†

â€œé™æ€â€ä»£ç†ï¼Œè‹¥ä»£ç†ç±»åœ¨ç¨‹åºè¿è¡Œå‰å·²ç»å­˜åœ¨ï¼Œè¿™ç§é€šå¸¸ç§°ä¸ºé™æ€ä»£ç†ï¼Œæ¯”å¦‚å¾®å•†Aåªä»£ç†Aå“ç‰Œçš„é¢è†œ,æ¶ˆè´¹è€…é€šè¿‡å¾®å•†æ‰èƒ½ä¹°åˆ°æŸå‚çš„é¢è†œ(æ§åˆ¶æƒ)ï¼Œå…¶ä¸­å¾®å•†å’Œå·¥å‚éƒ½å®ç°äº†äº†Sellçš„æ¥å£

> å§”æ‰˜ç±»é¢è†œå·¥å‚

```
class  FactoryOne :SellMask{
    override fun sell() {
        println("FactoryOne: æ¥è‡ªå·¥å‚Açš„é¢è†œ")
    }
}
å¤åˆ¶ä»£ç 
```

> å¾®å•†é™æ€ä»£ç†

```
class BusinessAgent : SellMask {
    private lateinit var sellMask: SellMask

    init {
        sellMask = FactoryOne()
    }

    override fun sell() {
        println("BusinessAgent: å¾®å•†ä»£ç†å¼€å§‹åœ¨æœ‹å‹åœˆæ‰“å¹¿å‘Š")
        sellMask.sell()
        print("BusinessAgent: èµšäº†ä¸€å¤§æŠŠ")
    }
}
å¤åˆ¶ä»£ç 
```

å…±åŒæ¥å£

```
interface SellMask {
    fun sell()
}
å¤åˆ¶ä»£ç 
```

## 2.3ã€ç›¸ä¼¼æ¨¡å¼çš„æ¯”è¾ƒ

æ—¢ç„¶è·å¾—å¼•ç”¨å°±å¯ä»¥åšä¸€äº›æ‰©å±•ä¹‹ç±»çš„äº‹æƒ…ï¼Œè¿™ç‚¹è·Ÿè£…é¥°è€…æ¨¡å¼ã€é€‚é…å™¨æ¨¡å¼çœ‹èµ·æ¥å¾ˆåƒï¼Œä¸‰è€…éƒ½å±äºç»“æ„å‹æ¨¡å¼ï¼Œä½†æ˜¯ä»£ç†æ¨¡å¼æ ¸å¿ƒæ˜¯ä¸ºå…¶å®ƒå¯¹è±¡æä¾›ä¸€ç§ä»£ç†ä»¥æ§åˆ¶å¯¹è¿™ä¸ªå¯¹è±¡çš„è®¿é—®()



> ä»£ç†æ¨¡å¼ VS é€‚é…å™¨æ¨¡å¼

çœ‹ä¸Šå»å¾ˆåƒï¼Œå®ƒä»¬éƒ½å¯è§†ä¸ºä¸€ä¸ªå¯¹è±¡æä¾›ä¸€ç§å‰ç½®çš„æ¥å£ï¼Œä½†æ˜¯é€‚é…å™¨æ¨¡å¼çš„ç”¨æ„æ˜¯æ”¹å˜æ‰€è€ƒè™‘çš„å¯¹è±¡çš„æ¥å£ï¼Œè€Œä»£ç†æ¨¡å¼å¹¶ä¸èƒ½æ”¹å˜æ‰€ä»£ç†çš„å¯¹è±¡çš„æ¥å£ï¼Œè¿™ä¸€ç‚¹ä¸Šä¸¤ä¸ªæ¨¡å¼æœ‰ç€æ˜æ˜¾çš„åŒºåˆ«ï¼Œä¸‹å›¾åˆ†åˆ«æ˜¯ å¯¹è±¡é€‚é…å™¨å’Œç±»çš„é€‚é…å™¨UMLå›¾



![image.png](https://user-gold-cdn.xitu.io/2019/2/22/16915a41d9a53c4a?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)







> ä»£ç†æ¨¡å¼VS è£…é¥°æ¨¡å¼

è£…é¥°è€…æ¨¡å¼ä¸æ‰€è£…é¥°çš„å¯¹è±¡æœ‰ç€ç›¸åŒçš„æ¥å£ï¼Œè¿™ä¸€ç‚¹è·Ÿä»£ç†æ¨¡å¼ç›¸åŒï¼Œä½†æ˜¯è£…é¥°æ¨¡å¼æ›´å¼ºè°ƒä¸ºæ‰€è£…é¥°çš„å¯¹è±¡æä¾›å¢å¼ºåŠŸèƒ½ï¼Œè€Œä»£ç†æ¨¡å¼åˆ™æ˜¯å¯¹å¯¹è±¡çš„ä½¿ç”¨æ–½åŠ æ§åˆ¶ï¼Œå¹¶ä¸æä¾›å¯¹è±¡æœ¬èº«çš„å¢å¼ºåŠŸèƒ½ï¼›è¢«ä»£ç†å¯¹è±¡ç”±ä»£ç†å¯¹è±¡åˆ›å»ºï¼Œå®¢æˆ·ç«¯ç”šè‡³ä¸éœ€è¦çŸ¥é“è¢«ä»£ç†ç±»çš„å­˜åœ¨ï¼›è¢«è£…é¥°å¯¹è±¡ç”±å®¢æˆ·ç«¯åˆ›å»ºå¹¶ä¼ ç»™è£…é¥°å¯¹è±¡ã€‚è£…é¥°è€…UMLå›¾å¦‚ä¸‹



![image.png](https://user-gold-cdn.xitu.io/2019/2/22/16915a41d9bb2a1a?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)



ä½ ä»¥ä¸ºè¿™å°±å®Œäº†å—ï¼Ÿä¸‹é¢ğŸ‘‡æ‰æ˜¯é‡å¤´æˆï¼

# ä¸‰ã€æ·±å…¥ç†è§£åŠ¨æ€ä»£ç†

## 3.1ã€ä»€ä¹ˆæ˜¯åŠ¨æ€ä»£ç†

ä»£ç†ç±»åœ¨ç¨‹åºè¿è¡Œæ—¶åˆ›å»ºçš„ä»£ç†æ–¹å¼è¢«æˆä¸º åŠ¨æ€ä»£ç†ã€‚å³ä»£ç†ç±»å¹¶ä¸æ˜¯åœ¨ä»£ç ä¸­å®šä¹‰çš„ï¼Œè€Œæ˜¯åœ¨è¿è¡Œæ—¶æ ¹æ®æˆ‘ä»¬åœ¨Javaä»£ç ä¸­"è§„å®š"çš„ä¿¡æ¯è‡ªåŠ¨ç”Ÿæˆã€‚é™æ€ä»£ç†å®¹æ˜“é€ æˆä»£ç çš„è†¨èƒ€ï¼Œã€‚ç›¸æ¯”äºé™æ€ä»£ç†ï¼Œ åŠ¨æ€ä»£ç†çš„ä¼˜åŠ¿åœ¨äºå¯ä»¥å¾ˆæ–¹ä¾¿çš„å¯¹ä»£ç†ç±»çš„å‡½æ•°è¿›è¡Œç»Ÿä¸€çš„å¤„ç†ï¼Œè€Œä¸ç”¨ä¿®æ”¹æ¯ä¸ªä»£ç†ç±»çš„å‡½æ•°ã€‚ è¿˜æ˜¯ä»¥ä¸Šé¢çš„å–é¢è†œå¾®å•†ä¸ºä¾‹ï¼Œå¥¹åœ¨è¿›è´§å¸‚åœºè¿›è¡Œä¸€ç•ªæ¯”è¾ƒä¹‹åå†å†³å®šä»£ç†å“ªä¸ªå“ç‰Œçš„é¢è†œã€‚

## 3.2ã€å¦‚ä½•ä½¿ç”¨åŠ¨æ€ä»£ç†

è·Ÿä¸Šæ–‡ä¸€æ ·ï¼Œå¾®å•†å’Œé¢è†œå·¥å‚éƒ½å®ç°äº†sellæ¥å£ï¼Œè¿™é‡Œå°±ä¸èµ˜è¿°äº†ï¼Œä¸‹é¢çœ‹ä¸‹ä¸ä¼—ä¸åŒçš„åœ°æ–¹ï¼Œå®ç°åŠ¨æ€ä»£ç†éœ€è¦å®ç°InvocationHandleræ¥å£

> å®ç°InvocationHandleræ¥å£

```
public class DynamicProxy implements InvocationHandler {
    private Object object;//è¢«å¼•ç”¨çš„ä»£ç†

    public Object newProxyInstance(Object object) {
        this.object = object;
        return Proxy.newProxyInstance(object.getClass().getClassLoader(),object.getClass().getInterfaces(),this);
    }

    @Override
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        System.out.println("ä»£ç†å•† åŒ…è£…å‘æœ‹å‹åœˆ");
        Object result = method.invoke(object,args);
        System.out.println("ä»£ç†å•† èµšé’±");
        return result;
    }
}
å¤åˆ¶ä»£ç 
```

- target å±æ€§è¡¨ç¤ºå§”æ‰˜ç±»å¯¹è±¡
- `InvocationHandler`æ˜¯è´Ÿè´£è¿æ¥ä»£ç†ç±»å’Œå§”æ‰˜ç±»çš„ä¸­é—´ç±»å¿…é¡»å®ç°çš„æ¥å£ã€‚å…¶ä¸­åªæœ‰ä¸€ä¸ª invokeå‡½æ•°éœ€è¦å®ç°
- invokeå‡½æ•°

```
public Object invoke(Object proxy, Method method, Object[] args)
å¤åˆ¶ä»£ç 
```

ä¸‹é¢å¥½å¥½çœ‹çœ‹è¿™ä¸ªæ ¸å¿ƒå‡½æ•°çš„å‚æ•°å«ä¹‰

- proxy ä»£é€šè¿‡dynamicproxy.newProxyInstance(business)è‡ªåŠ¨ç”Ÿæˆçš„ä»£ç†ç±» $Proxy0.class(ä¸‹æ–‡ä¼šè¯¦ç»†ä»‹ç»)
- methodè¡¨ç¤ºä»£ç†å¯¹è±¡è¢«è°ƒç”¨çš„å‡½æ•°ï¼Œæ¯”å¦‚sellMaskæ¥å£é‡Œé¢çš„sellæ–¹æ³•
- args è¡¨ç¤ºä»£ç†å¤§åŠ›è°ƒç”¨å‡½æ•°çš„çš„å‚æ•°ï¼Œè¿™é‡Œsellæ–¹æ³•æ— å‚æ•°

è°ƒç”¨ä»£ç†å¯¹è±¡çš„æ¯ä¸ªå‡½æ•°ï¼Œå®é™…ä¸Šæœ€ç»ˆéƒ½æ˜¯èµ°åˆ°InvocationHandlerçš„invokeå‡½æ•°ï¼Œå› æ­¤å¯ä»¥åœ¨è¿™é‡Œåšä¸€äº›ç»Ÿä¸€çš„å¤„ç†ï¼ŒAOPçš„é›å½¢å°±æ…¢æ…¢å‡ºç°äº†ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æ ¹æ®methodæ–¹æ³•ååšä¸€äº›åˆ¤æ–­ï¼Œä»è€Œå®ç°å¯¹æŸäº›å‡½æ•°çš„ç‰¹æ®Šå¤„ç†ã€‚

> ä½¿ç”¨åŠ¨æ€ä»£ç†

```
fun main(args: Array<String>) {
    System.getProperties().put("sun.misc.ProxyGenerator.saveGeneratedFiles", "true")  //åŠ å…¥è¿™ä¸ªå¯ä»¥è·å–ä»£ç†ç±»

    var maskFactory = FactoryMaskOne()

    var dynamicproxy: DynamicProxy = DynamicProxy()

    var sellMask: SellMask = dynamicproxy.newProxyInstance(maskFactory) as SellMask

    sellMask.sell()

}
å¤åˆ¶ä»£ç 
```

æˆ‘ä»¬å°†å§”æ‰˜ç±»é¢è†œå·¥ç¨‹FactoryMaskOneä¼ åˆ°dynamicproxy.newProxyInstanceä¸­ï¼Œé€šè¿‡ä¸‹é¢çš„å‡½æ•°è¿”å›äº†ä¸€ä¸ªä»£ç†å¯¹è±¡

```
public Object newProxyInstance(Object object) {
        this.object = object;
        return Proxy.newProxyInstance(object.getClass().getClassLoader(),object.getClass().getInterfaces(),this);
    }
å¤åˆ¶ä»£ç 
```

å®é™…ä»£ç†ç±»å°±æ˜¯åœ¨è¿™ä¸ªæ—¶å€™åŠ¨æ€ç”Ÿæˆçš„ï¼Œåç»­è°ƒç”¨åˆ°è¿™ä¸ªä»£ç†ç±»çš„å‡½æ•°å°±ä¼šç›´æ¥è°ƒç”¨invokeå‡½æ•°ï¼Œè®©æˆ‘ä»¬ç»†ç»†çœ‹ä¸‹è¿™ä¸ªProxy.newProxyInstance

```
public static Object newProxyInstance(ClassLoader loader, Class<?>[] interfaces, InvocationHandler h)
å¤åˆ¶ä»£ç 
```

æ³•çš„ä¸‰ä¸ªå‚æ•°å«ä¹‰åˆ†åˆ«å¦‚ä¸‹ï¼š

- loaderï¼šå®šä¹‰äº†ä»£ç†ç±»çš„ClassLoder;
- interfacesï¼šä»£ç†ç±»å®ç°çš„æ¥å£åˆ—è¡¨
- hï¼šè°ƒç”¨å¤„ç†å™¨ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä¸Šé¢å®šä¹‰çš„å®ç°äº†InvocationHandleræ¥å£çš„ç±»å®ä¾‹

è¿™é‡Œç®€å•æ€»ç»“ä¸€ä¸‹ï¼Œå§”æ‰˜ç±»é€šè¿‡**newProxyInstance **æ–¹æ³•è·å–åŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»çš„å®ä¾‹(æœ¬ä¾‹æ˜¯$Proxy0.class),ç„¶åå¯ä»¥é€šè¿‡è¿™ä¸ªä»£ç†ç±»å®ä¾‹è°ƒç”¨ä»£ç†çš„æ–¹æ³•è·å¾—å§”æ‰˜ç±»çš„æ§åˆ¶æƒï¼Œå¯¹ä»£ç†ç±»çš„è°ƒç”¨å®é™…ä¸Šéƒ½ä¼šèµ°åˆ°invokeæ–¹æ³•ï¼Œåœ¨è¿™é‡Œæˆ‘ä»¬è°ƒç”¨å§”æ‰˜ç±»çš„ç›¸åº”æ–¹æ³•ï¼Œå¹¶ä¸”å¯ä»¥æ·»åŠ è‡ªå·±çš„ä¸€äº›é€»è¾‘ï¼Œæ¯”å¦‚ç»Ÿä¸€å¤„ç†ç™»é™†ã€æ ¡éªŒä¹‹ç±»çš„ã€‚

## 3.3ã€åŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»$Proxy0

åœ¨Android Studioä¸­è°ƒç”¨ä¸äº†`ProxyGenerator`è¿™ä¸ªç±»,è¿™ä¸ªç±»åœ¨sun.miscåŒ…ä¸­,ä½¿ç”¨IntelliJ IDEåˆ›å»ºjavaå·¥ç¨‹ï¼Œéœ€è¦çœ‹ä¸€ä¸‹[jdk](https://juejin.im/post/5c70094051882562a12aec51)çš„åå°„ä¸­Proxyå’Œç”Ÿæˆçš„ä»£ç†ç±»$Proxy0çš„æºç ï¼Œå¯ä»¥ä½¿ç”¨

```
//ç”Ÿæˆ$Proxy0çš„classæ–‡ä»¶
System.getProperties().put("sun.misc.ProxyGenerator.saveGeneratedFiles", "true");
å¤åˆ¶ä»£ç 
```

ç”Ÿæˆçš„ä»£ç†ç±»åœ¨com.sun.proxyåŒ…é‡Œé¢å®Œæ•´ä»£ç å¦‚ä¸‹

```
public final class $Proxy0 extends Proxy implements SellMask {
    private static Method m1;
    private static Method m2;
    private static Method m3;
    private static Method m0;

    public $Proxy0(InvocationHandler var1) throws  {
        super(var1);
    }

    public final boolean equals(Object var1) throws  {
        try {
            return (Boolean)super.h.invoke(this, m1, new Object[]{var1});
        } catch (RuntimeException | Error var3) {
            throw var3;
        } catch (Throwable var4) {
            throw new UndeclaredThrowableException(var4);
        }
    }

    public final String toString() throws  {
        try {
            return (String)super.h.invoke(this, m2, (Object[])null);
        } catch (RuntimeException | Error var2) {
            throw var2;
        } catch (Throwable var3) {
            throw new UndeclaredThrowableException(var3);
        }
    }
	
    public final void sell() throws  {
        try {
          //å¯ä»¥çœ‹åˆ°æ¥å£æ–¹æ³•éƒ½äº¤ç”±hçš„invokeæ–¹æ³•å¤„ç†ï¼Œhåœ¨çˆ¶ç±»Proxyä¸­å®šä¹‰ä¸ºInvocationHandleræ¥å£
            super.h.invoke(this, m3, (Object[])null);
        } catch (RuntimeException | Error var2) {
            throw var2;
        } catch (Throwable var3) {
            throw new UndeclaredThrowableException(var3);
        }
    }

    public final int hashCode() throws  {
        try {
            return (Integer)super.h.invoke(this, m0, (Object[])null);
        } catch (RuntimeException | Error var2) {
            throw var2;
        } catch (Throwable var3) {
            throw new UndeclaredThrowableException(var3);
        }
    }

    static {
        try {
            m1 = Class.forName("java.lang.Object").getMethod("equals", Class.forName("java.lang.Object"));
            m2 = Class.forName("java.lang.Object").getMethod("toString");
            m3 = Class.forName("dev.proxy.SellMask").getMethod("sell");
            m0 = Class.forName("java.lang.Object").getMethod("hashCode");
        } catch (NoSuchMethodException var2) {
            throw new NoSuchMethodError(var2.getMessage());
        } catch (ClassNotFoundException var3) {
            throw new NoClassDefFoundError(var3.getMessage());
        }
    }
}

å¤åˆ¶ä»£ç 
```

ä»ç”Ÿæˆçš„ä»£ç†ç±»ä¸­å¯ä»¥çœ‹åˆ°

- åŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»æ˜¯ä»¥`$Proxy`ä¸ºç±»åå‰ç¼€ï¼Œç»§æ‰¿è‡ª`Proxy`ï¼Œå¹¶ä¸”å®ç°äº†`Proxy.newProxyInstance(â€¦)`ç¬¬äºŒä¸ªå‚æ•°ä¼ å…¥çš„æ‰€æœ‰æ¥å£çš„ç±»ã€‚
- æ¥å£æ–¹æ³•éƒ½äº¤ç”±hçš„invokeæ–¹æ³•å¤„ç†ï¼Œhåœ¨çˆ¶ç±»Proxyä¸­å®šä¹‰ä¸ºInvocationHandleræ¥å£ï¼Œä¸ºProxy.newProxyInstance(â€¦)çš„ç¬¬ä¸‰ä¸ªå‚æ•°

## 3.4 åŠ¨æ€ä»£ç†ç±»å¦‚ä½•ç”Ÿæˆ

- å…³æ³¨ç‚¹1 Proxy.newProxyInstance(â€¦â€¦)å‡½æ•°

åŠ¨æ€ä»£ç†ç±»æ˜¯åœ¨è°ƒç”¨ Proxy.newProxyInstance(â€¦â€¦)å‡½æ•°æ—¶ç”Ÿæˆçš„ï¼Œç²¾ç®€åçš„æ ¸å¿ƒä»£ç å¦‚ä¸‹

```
public static Object newProxyInstance(ClassLoader loader,
                                          Class<?>[] interfaces,
                                          InvocationHandler h)
        throws IllegalArgumentException
    {
        
        final Class<?>[] intfs = interfaces.clone();
        â€¦â€¦
        /*
         * Look up or generate the designated proxy class.
         * å¾—åˆ°åŠ¨æ€ä»£ç†ç±»
         */
        Class<?> cl = getProxyClass0(loader, intfs);

        /*
         * Invoke its constructor with the designated invocation handler.
         */
        try {
            â€¦â€¦
            final Constructor<?> cons = cl.getConstructor(constructorParams);
            final InvocationHandler ih = h;
            if (!Modifier.isPublic(cl.getModifiers())) {
                AccessController.doPrivileged(new PrivilegedAction<Void>() {
                    public Void run() {
                        cons.setAccessible(true);
                        return null;
                    }
                });
            }
            //ç„¶åå°†InvocationHandlerä½œä¸ºä»£ç†ç±»æ„é€ å‡½æ•°å…¥å‚æ–°å»ºä»£ç†ç±»å¯¹è±¡
            return cons.newInstance(new Object[]{h});
        } catch (IllegalAccessException|InstantiationException e) {
           â€¦â€¦
    }
å¤åˆ¶ä»£ç 
```

å¯ä»¥çœ‹åˆ° é¦–å…ˆè°ƒç”¨å®ƒå…ˆè°ƒç”¨`getProxyClass(loader, interfaces)`å¾—åˆ°åŠ¨æ€ä»£ç†ç±»ï¼Œç„¶åå°†`InvocationHandler`ä½œä¸ºä»£ç†ç±»æ„é€ å‡½æ•°å…¥å‚æ–°å»ºä»£ç†ç±»å¯¹è±¡ã€‚

- å…³æ³¨ç‚¹2 Class<?> cl = getProxyClass0(loader, intfs);

å¦‚ä½•è·å–åˆ° ç”ŸæˆåŠ¨æ€ä»£ç†ç±»å‘¢ï¼Œä¸€æ­¥æ­¥è¿½è¸ªï¼Œæˆ‘ä»¬å‘ç°ï¼Œåœ¨Proxy#ProxyClassFactoryç±»ä¸­ï¼Œåœ¨ProxyGeneratorä¸­å»ç”ŸæˆåŠ¨æ€ä»£ç†ï¼Œç±»åä»¥$Proxy+numä½œä¸ºæ ‡è®°

```
						/*
             * Generate the specified proxy class.
             */
            byte[] proxyClassFile = ProxyGenerator.generateProxyClass(
                proxyName, interfaces, accessFlags);
            try {
                return defineClass0(loader, proxyName,
                                    proxyClassFile, 0, proxyClassFile.length);
            } catch (ClassFormatError e) {
                throw new IllegalArgumentException(e.toString());
            }
å¤åˆ¶ä»£ç 
```

# å°ç»“

æœ¬ç¯‡ä¸»è¦javaä¸­çš„ä»£ç†æ¨¡å¼ä»¥åŠè·Ÿå…¶ä»–æ¨¡å¼çš„å¯¹æ¯”ï¼Œå¹¶é‡ç‚¹ä»‹ç»äº†JDKä¸­çš„åŠ¨æ€ä»£ç†æœºåˆ¶ï¼ŒåƒAOPã€retrofitæ ¸å¿ƒæœºåˆ¶ä¹‹ä¸€å°±ä½¿ç”¨åˆ°äº†è¿™ç§æŠ€æœ¯ï¼Œä½†JavaåŠ¨æ€ä»£ç†æ˜¯åŸºäºæ¥å£çš„ï¼Œå¦‚æœå¯¹è±¡æ²¡æœ‰å®ç°æ¥å£æˆ‘ä»¬è¯¥å¦‚ä½•ä»£ç†å‘¢ï¼Ÿé‚£å°±éœ€è¦CGLIBäº†ï¼Œ[CGLIB](https://github.com/cglib/cglib)(*Code Generation Library*)æ˜¯ä¸€ä¸ªåŸºäº[ASM](http://www.baeldung.com/java-asm)çš„å­—èŠ‚ç ç”Ÿæˆåº“ï¼Œå®ƒå…è®¸æˆ‘ä»¬åœ¨è¿è¡Œæ—¶å¯¹å­—èŠ‚ç è¿›è¡Œä¿®æ”¹å’ŒåŠ¨æ€ç”Ÿæˆã€‚CGLIBé€šè¿‡ç»§æ‰¿æ–¹å¼å®ç°ä»£ç†ï¼Œè¿™é‡Œå°±ä¸å±•å¼€èµ˜è¿°äº†ã€‚

# å‚è€ƒé“¾æ¥

- [juejin.im/post/5a9904â€¦](https://juejin.im/post/5a99048a6fb9a028d5668e62)
- [juejin.im/post/5ad3e6â€¦](https://juejin.im/post/5ad3e6b36fb9a028ba1fee6a)
- [www.cnblogs.com/xiaoluo5013â€¦](http://www.cnblogs.com/xiaoluo501395377/p/3383130.html)
- [www.zhihu.com/question/20â€¦](https://www.zhihu.com/question/20794107)
- [blog.csdn.net/qq_27095957â€¦](https://blog.csdn.net/qq_27095957/article/details/80184291)
- [a.codekk.com/detail/Andrâ€¦](http://a.codekk.com/detail/Android/Caij/å…¬å…±æŠ€æœ¯ç‚¹ä¹‹ Java åŠ¨æ€ä»£ç†)
- [www.jianshu.com/p/0391a8e93â€¦](https://www.jianshu.com/p/0391a8e93d3d)